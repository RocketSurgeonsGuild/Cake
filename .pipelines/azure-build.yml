parameters:
  Script: 'cakefile.cake'
  Target: 'Default'
  Configuration: 'Release'
  Coverage: '$(Agent.BuildDirectory)/c'
  Artifacts: $(Build.ArtifactStagingDirectory)
  Verbosity: ''

steps:
- script: $(Agent.ToolsDirectory)/dotnet-cake cakefile.cake --Target="Default" --Configuration="$(Configuration)" --Artifacts="$(Artifacts)" --Coverage="$(Coverage)" --verbosity=$(Verbosity)
  displayName: 'dotnet cake'
  env:
    Configuration: ${{ parameters.Configuration }}
    Artifacts: ${{ parameters.Artifacts }}
    VstsArtifacts: ${{ parameters.Artifacts }}
    Coverage: ${{ parameters.Coverage }}
    VstsCoverage: ${{ parameters.Coverage }}
    Verbosity: ${{ parameters.Verbosity }}

- task: PublishTestResults@2
  displayName: Publish Tests
  condition: always()
  inputs:
    testRunner: "XUnit"
    testResultsFiles: "$(Artifacts)/test/**/*.xml"
    testRunTitle: "XUnit Results - $(system.phaseName)"
    buildPlatform: ${{ parameters.os }}
    buildConfiguration: ${{ parameters.Configuration }}
  env:
    Artifacts: ${{ parameters.Artifacts }}

- task: PublishCodeCoverageResults@1
  displayName: Publish Code Coverage
  condition: always()
  inputs:
    codeCoverageTool: "Cobertura"
    summaryFileLocation: "$(Coverage)/solution.cobertura"
    reportDirectory: "$(Coverage)/report/"
    # failIfCoverageEmpty: "true"
  env:
    Coverage: ${{ parameters.Coverage }}

- task: PublishBuildArtifacts@1
  displayName: Publish Logs
  condition: always()
  inputs:
    PathtoPublish: "$(Artifacts)/logs/"
    ArtifactName: "Logs - $(system.phaseName)"
    ArtifactType: "Container"
  env:
    Artifacts: ${{ parameters.Artifacts }}

- task: UsePythonVersion@0
  displayName: 'Use Python 3.x'

- task: RocketSurgeonsGuild.variable-tools.ExportServiceConnection.ExportServiceConnection@1
  displayName: 'Export Service Connection codecov'
  inputs:
    name: 1b2c9b1d-dd47-4ac2-ae44-e10d72cdd2b0
    prefix: codecov

- script: |
    pip install codecov
    codecov --file "$COVERAGE/solution.cobertura" --token $TOKEN --name $SYSTEM_PHASENAME --env SYSTEM_*,AGENT_*,TF*,BUILD* --commit $BUILD_SOURCEVERSION --branch $BUILD_SOURCEBRANCHNAME --build $BUILD_BUILDID --pr $SYSTEM_PULLREQUEST_PULLREQUESTNUMBER --slug $BUILD_REPOSITORY_ID
  env:
    COVERAGE: ${{ parameters.Coverage }}
    TOKEN: $(codecov.Authorization.password)

# codecov.Authorization.password
